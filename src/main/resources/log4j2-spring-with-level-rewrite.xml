<?xml version="1.0" encoding="UTF-8"?>
<Configuration status="WARN">
    <Properties>
        <Property name="LOG_DIR">logs</Property>
        <Property name="CHARSET">UTF-8</Property>
        <Property name="LOG_EXCEPTION_CONVERSION_WORD">%xwEx</Property>
        <Property name="LOG_LEVEL_PATTERN">%5p</Property>
        <Property name="LOG_DATEFORMAT_PATTERN">yyyy-MM-dd HH:mm:ss.SSS</Property>
        <Property name="CONSOLE_LOG_PATTERN">%clr{%d{${LOG_DATEFORMAT_PATTERN}}}{faint} %clr{${LOG_LEVEL_PATTERN}} [%X{X-RequestID}] %clr{%pid}{magenta} %clr{---}{faint} %clr{[%15.15t]}{faint} %clr{%-40.40c{1.}}{cyan} %clr{[%traceId]}{cyan} %clr{:}{faint} %m%n${sys:LOG_EXCEPTION_CONVERSION_WORD}</Property>
        <Property name="FILE_LOG_PATTERN">%d{${LOG_DATEFORMAT_PATTERN}} ${LOG_LEVEL_PATTERN} [%X{X-RequestID}] %pid --- [%t] %-40.40c{1.} [%traceId]: %m%n${sys:LOG_EXCEPTION_CONVERSION_WORD}</Property>
        <!-- Pattern that forces INFO level display -->
        <Property name="FILE_LOG_PATTERN_INFO_ONLY">%d{${LOG_DATEFORMAT_PATTERN}} INFO  [%X{X-RequestID}] %pid --- [%t] %-40.40c{1.} [%traceId]: %m%n${sys:LOG_EXCEPTION_CONVERSION_WORD}</Property>
    </Properties>

    <Appenders>
        <!-- Console Appender for general logs -->
        <Console name="Console" target="SYSTEM_OUT">
            <ThresholdFilter level="DEBUG" onMatch="ACCEPT" onMismatch="DENY" />
            <PatternLayout>
                <pattern>${CONSOLE_LOG_PATTERN}</pattern>
            </PatternLayout>
        </Console>

        <!-- Dedicated console appender for AWS JDBC Wrapper -->
        <Console name="AmazonJdbcConsole" target="SYSTEM_OUT">
            <PatternLayout>
                <pattern>${CONSOLE_LOG_PATTERN}</pattern>
            </PatternLayout>
        </Console>

        <!-- RollingFile Appender for INFO and above -->
        <RollingRandomAccessFile name="InfoFile"
                                 fileName="${LOG_DIR}/info.log"
                                 filePattern="${LOG_DIR}/archive/history_info.%d{yyyy-MM-dd}.%i.zip">
            <ThresholdFilter level="INFO" onMatch="ACCEPT" onMismatch="DENY" />
            <PatternLayout pattern="${FILE_LOG_PATTERN}" charset="${CHARSET}"/>
            <Policies>
                <TimeBasedTriggeringPolicy/>
                <SizeBasedTriggeringPolicy size="500 MB"/>
            </Policies>
            <DefaultRolloverStrategy max="7">
                <Delete basePath="${LOG_DIR}/archive" maxDepth="2">
                    <IfFileName glob="history_info.*"/>
                    <IfLastModified age="1d"/>
                </Delete>
            </DefaultRolloverStrategy>
        </RollingRandomAccessFile>

        <!-- Dedicated file appender for AWS JDBC Wrapper - all levels with original level -->
        <RollingRandomAccessFile name="AmazonJdbcFile"
                                 fileName="${LOG_DIR}/jdbc-wrapper.log"
                                 filePattern="${LOG_DIR}/archive/history_jdbc_wrapper.%d{yyyy-MM-dd}.%i.zip">
            <PatternLayout pattern="${FILE_LOG_PATTERN}" charset="${CHARSET}"/>
            <Policies>
                <TimeBasedTriggeringPolicy/>
                <SizeBasedTriggeringPolicy size="500 MB"/>
            </Policies>
            <ThresholdFilter level="TRACE" onMatch="ACCEPT" onMismatch="DENY" />
            <DefaultRolloverStrategy max="7">
                <Delete basePath="${LOG_DIR}/archive" maxDepth="2">
                    <IfFileName glob="history_jdbc_wrapper.*"/>
                    <IfLastModified age="1d"/>
                </Delete>
            </DefaultRolloverStrategy>
        </RollingRandomAccessFile>

        <!-- ⭐ NEW: Wrapper Debug logs written as INFO level -->
        <!-- This appender accepts DEBUG/TRACE logs but writes them with INFO level pattern -->
        <RollingRandomAccessFile name="AmazonJdbcDebugAsInfo"
                                 fileName="${LOG_DIR}/jdbc-wrapper-debug-as-info.log"
                                 filePattern="${LOG_DIR}/archive/history_jdbc_wrapper_debug_as_info.%d{yyyy-MM-dd}.%i.zip">
            <!-- Accept DEBUG and TRACE levels -->
            <Filters>
                <!-- Accept DEBUG level -->
                <LevelRangeFilter minLevel="DEBUG" maxLevel="DEBUG" onMatch="ACCEPT" onMismatch="NEUTRAL"/>
                <!-- Accept TRACE level -->
                <LevelRangeFilter minLevel="TRACE" maxLevel="TRACE" onMatch="ACCEPT" onMismatch="NEUTRAL"/>
                <!-- Deny everything else -->
                <ThresholdFilter level="INFO" onMatch="DENY" onMismatch="DENY"/>
            </Filters>
            <!-- Use INFO-only pattern to force INFO level display -->
            <PatternLayout pattern="${FILE_LOG_PATTERN_INFO_ONLY}" charset="${CHARSET}"/>
            <Policies>
                <TimeBasedTriggeringPolicy/>
                <SizeBasedTriggeringPolicy size="500 MB"/>
            </Policies>
            <DefaultRolloverStrategy max="7">
                <Delete basePath="${LOG_DIR}/archive" maxDepth="2">
                    <IfFileName glob="history_jdbc_wrapper_debug_as_info.*"/>
                    <IfLastModified age="1d"/>
                </Delete>
            </DefaultRolloverStrategy>
        </RollingRandomAccessFile>

        <!-- Dedicated InfoFile for AWS JDBC Wrapper - INFO and above with original level -->
        <RollingRandomAccessFile name="AmazonJdbcInfoFile"
                                 fileName="${LOG_DIR}/jdbc-wrapper-info.log"
                                 filePattern="${LOG_DIR}/archive/history_jdbc_wrapper_info.%d{yyyy-MM-dd}.%i.zip">
            <ThresholdFilter level="INFO" onMatch="ACCEPT" onMismatch="DENY" />
            <PatternLayout pattern="${FILE_LOG_PATTERN}" charset="${CHARSET}"/>
            <Policies>
                <TimeBasedTriggeringPolicy/>
                <SizeBasedTriggeringPolicy size="500 MB"/>
            </Policies>
            <DefaultRolloverStrategy max="7">
                <Delete basePath="${LOG_DIR}/archive" maxDepth="2">
                    <IfFileName glob="history_jdbc_wrapper_info.*"/>
                    <IfLastModified age="1d"/>
                </Delete>
            </DefaultRolloverStrategy>
        </RollingRandomAccessFile>

        <!-- RollingFile for ERROR logs -->
        <RollingRandomAccessFile name="ErrorFile"
                                 fileName="${LOG_DIR}/error.log"
                                 filePattern="${LOG_DIR}/archive/history_error.%d{yyyy-MM-dd}.%i.zip">
            <PatternLayout pattern="${FILE_LOG_PATTERN}" charset="${CHARSET}"/>
            <Policies>
                <TimeBasedTriggeringPolicy/>
                <SizeBasedTriggeringPolicy size="500 MB"/>
            </Policies>
            <ThresholdFilter level="ERROR" onMatch="ACCEPT" onMismatch="DENY"/>
            <DefaultRolloverStrategy max="7">
                <Delete basePath="${LOG_DIR}/archive" maxDepth="2">
                    <IfFileName glob="history_error.*"/>
                    <IfLastModified age="1d"/>
                </Delete>
            </DefaultRolloverStrategy>
        </RollingRandomAccessFile>

        <!-- Separate RollingFile for Spring Boot logs -->
        <RollingRandomAccessFile name="SpringBootFile" 
                     fileName="${LOG_DIR}/spring-boot.log"
                     filePattern="${LOG_DIR}/archive/spring-boot-%d{yyyy-MM-dd}.%i.zip">
            <PatternLayout pattern="${FILE_LOG_PATTERN}" charset="${CHARSET}"/>
            <Policies>
                <TimeBasedTriggeringPolicy/>
                <SizeBasedTriggeringPolicy size="50 MB"/>
            </Policies>
            <DefaultRolloverStrategy max="10">
                <Delete basePath="${LOG_DIR}/archive" maxDepth="2">
                    <IfFileName glob="spring-boot-*"/>
                    <IfLastModified age="7d"/>
                </Delete>
            </DefaultRolloverStrategy>
        </RollingRandomAccessFile>
    </Appenders>

    <Loggers>
        <!-- JUL bridge logger - prevent infinite recursion -->
        <Logger name="org.slf4j.bridge" level="INFO" additivity="false">
            <AppenderRef ref="Console"/>
            <AppenderRef ref="InfoFile"/>
        </Logger>

        <!-- AWS JDBC Wrapper Logger - controlled by wrapperLoggerLevel in JDBC URL -->
        <!-- Level is set to "all" here to accept whatever JUL sends via SLF4JBridgeHandler -->
        <Logger name="software.amazon.jdbc" level="all" additivity="false">
            <AppenderRef ref="AmazonJdbcConsole"/>
            <AppenderRef ref="AmazonJdbcFile"/>
            <AppenderRef ref="AmazonJdbcInfoFile"/>
            <AppenderRef ref="InfoFile"/>  <!-- ⭐ Also write to general InfoFile (DEBUG will be written as-is) -->
            <AppenderRef ref="ErrorFile"/>
        </Logger>

        <!-- Druid Logger -->
        <Logger name="com.alibaba.druid" level="info" additivity="false">
            <AppenderRef ref="Console"/>
            <AppenderRef ref="InfoFile"/>
        </Logger>
        
        <!-- Druid SQL Logger -->
        <Logger name="druid.sql" level="info" additivity="false">
            <AppenderRef ref="Console"/>
            <AppenderRef ref="InfoFile"/>
        </Logger>
        
        <!-- Druid SQL Statement Logger -->
        <Logger name="druid.sql.Statement" level="debug" additivity="false">
            <AppenderRef ref="Console"/>
            <AppenderRef ref="InfoFile"/>
        </Logger>

        <!-- Spring Framework Logger -->
        <Logger name="org.springframework" level="info" additivity="false">
            <AppenderRef ref="Console"/>
            <AppenderRef ref="SpringBootFile"/>
        </Logger>

        <!-- Spring Boot Logger -->
        <Logger name="org.springframework.boot" level="info" additivity="false">
            <AppenderRef ref="Console"/>
            <AppenderRef ref="SpringBootFile"/>
        </Logger>

        <!-- Application Logger -->
        <Logger name="com.test" level="debug" additivity="false">
            <AppenderRef ref="Console"/>
            <AppenderRef ref="InfoFile"/>
        </Logger>

        <!-- Root Logger -->
        <Root level="info" includeLocation="false">
            <AppenderRef ref="Console"/>
            <AppenderRef ref="InfoFile"/>
            <AppenderRef ref="ErrorFile"/>
        </Root>
    </Loggers>
</Configuration>
